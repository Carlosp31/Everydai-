<!DOCTYPE html>
<html lang="es">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

    <title>Chat with EverydAI</title>
</head>
<body>
    <div id="loading-screen">
        <div class="spinner"></div>
        <p class="loading-text">Loading</p>
    </div>
<div class="content" id="content"></div>
    <button class ="redirect-button" onclick="redirectToRealidad()">Scan</button>
    <!-- Mostrar el modelo seleccionado din√°micamente -->
    <div id="recommendations-box" class="recommendations-box">
        <div class="header">
            <h3>Recommendations:</h3>
            <div id="toggle-arrow" class="arrow-container">
                <div class="arrow down"></div> <!-- Flecha personalizada -->
            </div>
        </div>
        <ul id="recommendations-list"></ul>
    </div>
    <button id="download-button">Download Conversation</button>
    <button id="cart-button">Cart</button>
    <div id="cart-dropdown" style="display:none;">
        <ul id="cart-items"></ul>
    </div>
    <button id="inventory-button">Inventory</button>
    <div id="inventory-dropdown" style="display:none;">
        <ul id="inventory-items"></ul>
    </div>
    
    <script src="../static/java/inventories.js"></script>
    


    <div class="chat-container">
        <h1>Chat with EverydAI</h1>
        <div id="selected-model-display" class="selected-model-display">
            <span class="emoji">
                {% if domain == "Cooking" %}
                    üçΩÔ∏è
                {% elif domain == "fashion" %}
                    üëî
                {% elif domain == "Fitness" %}
                    üèÉ
                {% else %}
                    üåê
                {% endif %}
            </span>
            {{ domain }}
        </div>
        <div id="avatar-container">
            <div id="subtitulos-container"></div>
            <div class="dots" id="dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <div id="chat-box" class="hidden"></div>
        <input type="text" id="user-input" placeholder="Chat with us...">
        <div class="control-container">
            <button id="microphone-button">Start Conversation</button>
            <label for="image-input" id="image-input-label">Select Image</label>
            <button id="upload-button">Upload Image</button>
            <button id="camera-button">Open Camera</button>
            <button id="send-button">Send</button>
            <button id="capture-button" style="display:none;">Capture</button>
        </div>
        <input type="file" id="image-input" accept="image/*">

        <!-- Canvas para el espectro de frecuencias -->
        <canvas id="frequency-canvas"></canvas>

        <video id="video-preview" autoplay style="display:none; width: 300px;"></video>
        <canvas id="canvas" style="display:none;"></canvas>

        <div id="image-preview-container" style="text-align: center;">
            <img id="image-preview" alt="Your uploaded image will appear here" style="display: none; width: 300px; margin-top: 10px;">
        </div>
    </div>
</div>    
    <script src="../static/java/recommendations.js"></script>
    <script src="../static/java/chat.js"></script>
    <!-- <script src="../static/java/cartshop.js"></script> -->


    <!-- Aqu√≠ agregamos el popup -->
    <div id="popup" class="popup hidden"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script>
        var models = {
            "Cooking": {
                "modelPath": "{{ url_for('static', filename='models/avatar1.glb') }}",
                "animationPath": "{{ url_for('static', filename='animations/animationschef.glb') }}"
            },
            "fashion": {
                "modelPath": "{{ url_for('static', filename='models/avatar3.glb') }}",
                "animationPath": "{{ url_for('static', filename='animations/animationsfashion.glb') }}"
            },
            "Fitness": {
                "modelPath": "{{ url_for('static', filename='models/avatar2.glb') }}",
                "animationPath": "{{ url_for('static', filename='animations/animationsgym.glb') }}"
            }
        };
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const urlParams = new URLSearchParams(window.location.search);
        let domain = urlParams.get('domain');
    });
               window.onload = function() {
                setTimeout(() => {
                    document.getElementById("loading-screen").style.opacity = "0";
                }, 2000);
                setTimeout(() => {
                        document.getElementById("loading-screen").style.display = "none";
                        document.getElementById("content").style.display = "block";
                    }, 500);
            };
            function redirectToRealidad() {
                let selectedModel = domain;
    
                window.location.href = `/realidadpro3?domain=${encodeURIComponent(selectedModel)}`;
            }
            document.addEventListener("DOMContentLoaded", function() {
                const microphoneButton = document.getElementById("microphone-button");
                const frequencyCanvas = document.getElementById("frequency-canvas");
                const canvasContext = frequencyCanvas.getContext("2d");
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const imageInput = document.getElementById("image-input");
                const imagePreview = document.getElementById("image-preview");
                const videoPreview = document.getElementById("video-preview");
                const canvas = document.getElementById("canvas");
                const captureButton = document.getElementById("capture-button");
                let selectedModel = domain;
                let recognition;
                let analyser;
                let isListening = false;
                let isBotSpeaking = false; // Variable para saber si el bot est√° hablando
                // Funci√≥n para iniciar el reconocimiento de voz y el espectro de frecuencias
                function startVoiceRecognition() {
                    if (!recognition) {
                        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                        recognition.lang = 'es-ES';
                        recognition.continuous = false;
                        recognition.interimResults = false;
                    }
    
                    recognition.onresult = function(event) {
                        if (!isBotSpeaking) { // Solo procesar si el bot no est√° hablando
                            const userInput = event.results[0][0].transcript;
                            document.getElementById("user-input").value = userInput;
                            sendMessage(userInput);
                            dots.style.opacity = 1; // Mostrar los puntos
                            const event5 = new CustomEvent('pensar');
                            window.dispatchEvent(event5);
                        }
                    };
    
                    recognition.onerror = function(event) {
                        console.error("Error en el reconocimiento de voz: ", event.error);
                    };
    
                    recognition.onend = function() {
                        if (isListening && !isBotSpeaking) {
                            recognition.start(); // Reiniciar reconocimiento si sigue en modo escucha
                        }
                    };
    
                    recognition.start();
                    startFrequencySpectrum(); // Iniciar el espectro de frecuencias
                }
    
                // Evento para iniciar o detener el reconocimiento de voz con el bot√≥n de 'Start Conversation'
                microphoneButton.onclick = function() {
                    if (!isListening) {
                        isListening = true;
                        microphoneButton.innerText = "Stop Conversation";
                        startVoiceRecognition();
                    } else {
                        isListening = false;
                        microphoneButton.innerText = "Start Conversation";
                        if (recognition) {
                            recognition.stop();
                        }
                        stopFrequencySpectrum();
                    }
                };
    
                // Funci√≥n para iniciar el espectro de frecuencias
                function startFrequencySpectrum() {
                    navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
                        const source = audioContext.createMediaStreamSource(stream);
                        analyser = audioContext.createAnalyser();
                        source.connect(analyser);
                        analyser.fftSize = 256;
    
                        frequencyCanvas.style.display = "block";
                        drawFrequencySpectrum();
                    }).catch((error) => {
                        console.error("Error al acceder al micr√≥fono: ", error);
                    });
                }
    
                // Funci√≥n para detener el espectro de frecuencias
                function stopFrequencySpectrum() {
                    frequencyCanvas.style.display = "none";
                }
    
                // Funci√≥n para dibujar el espectro de frecuencias
                function drawFrequencySpectrum() {
                    if (!isListening) return;
    
                    requestAnimationFrame(drawFrequencySpectrum);
    
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    analyser.getByteFrequencyData(dataArray);
    
                    canvasContext.clearRect(0, 0, frequencyCanvas.width, frequencyCanvas.height);
                    const barWidth = (frequencyCanvas.width / bufferLength) * 2.5;
                    let barHeight;
                    let x = 0;
    
                    for (let i = 0; i < bufferLength; i++) {
                        barHeight = dataArray[i] / 2;
                        canvasContext.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
                        canvasContext.fillRect(x, frequencyCanvas.height - barHeight, barWidth, barHeight);
                        x += barWidth + 1;
                    }
                }
    
                // Funci√≥n para enviar mensajes (tanto por texto como por voz)
               function sendMessage(userInput) {
        if (userInput.trim() !== "") {
            document.getElementById("chat-box").innerHTML += `<div>Usuario: ${userInput}</div>`;
            document.getElementById("user-input").value = ''; // Limpiar el input despu√©s de enviar
    
            // Detener temporalmente el reconocimiento de voz mientras se obtiene la respuesta del bot
            if (recognition) recognition.stop();
            isBotSpeaking = true;
    
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: userInput, model: selectedModel }),
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("chat-box").innerHTML += `<div>AI: ${data.text_response}</div>`;
                speakResponse(data.text_response);
    
            // Verificar si data.recipes es un array antes de recorrerlo
            if (Array.isArray(data.recipes)) {
                data.recipes.forEach(item => {
                    const listItem = document.createElement("li");
    
                    // Verificamos si el objeto tiene las llaves 'nombre' y 'precio'
                    if (item.nombre && item.precio) {
                        listItem.innerHTML = `<div class="producto">
                                <span class="producto-nombre">${item.nombre}</span> - 
                                <span class="producto-precio">${item.precio}</span>
                                <button onclick="addToCart({nombre: '${item.nombre}', precio: '${item.precio}'})">Add to list</button>
                            </div>`;
    
                        // Verificamos si tambi√©n tiene la URL de la imagen
                        if (item.imagen_url) {
                            // Crear un elemento de imagen y asignarle la URL
                            const imgElement = document.createElement("img");
                            imgElement.src = item.imagen_url;
                            imgElement.alt = item.nombre;
                            imgElement.classList.add("producto-imagen");  // A√±adir clase CSS
    
                            // A√±adir la miniatura de la imagen al `listItem`
                            listItem.prepend(imgElement);
                        }
    
                        // Agregar una clase para dar estilo a los productos con nombre y precio
                        listItem.classList.add("producto-con-precio");
                    } else if (item.link && item.title) {
                        // Si tiene 'link' y 'title', mostramos la receta
                        listItem.innerHTML = `<div>
                                                <a href="${item.link}" target="_blank">${item.title}</a>
                                                <button onclick="addToCart({link: '${item.link}', title: '${item.title}'})">Add to cart</button>
                                            </div>`;
                    } else {
                        // Si no tiene 'nombre' y 'precio' ni 'link' y 'title', mostramos un mensaje por defecto
                        listItem.innerHTML = "Informaci√≥n no v√°lida";
                    }
    
                    // A√±adir cada item a la lista de recomendaciones
                    recommendationsList.appendChild(listItem);
                });
            } else {
                recommendationsList.innerHTML = '<li>No se encontraron recomendaciones.</li>';
            }
    
            })
            .catch(error => console.error('Error:', error));
        }
    }
    
    
                // Mostrar las recomendaciones en el cuadro de recomendaciones
                const recommendationsList = document.getElementById("recommendations-list");
                recommendationsList.innerHTML = '';  // Limpiar la lista existente
    
    
                // Funci√≥n para sintetizar y reproducir el audio de la respuesta
                function speakResponse(responseText) {
                    const subtitulosContainer = document.getElementById("subtitulos-container");
                    if (!subtitulosContainer) {
                        console.error("El contenedor de subt√≠tulos no existe.");
                        return;
                    }
                        // Mostrar subt√≠tulos
                    //subtitulosContainer.textContent = responseText;
                    //subtitulosContainer.style.display = "block";
    
                    fetch('/synthesize-audio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ text: responseText, modelo: selectedModel  }),
                    })
                    .then(audioResponse => {
                        if (audioResponse.ok) return audioResponse.blob();
                        throw new Error('Error al obtener el audio.');
                    })
                    .then(audioBlob => {
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const analyser = audioContext.createAnalyser();
                        const source = audioContext.createMediaElementSource(audio);
                        source.connect(analyser);
                        analyser.connect(audioContext.destination);
    
                        const dataArray = new Uint8Array(analyser.frequencyBinCount);
    
                        function emitAudioLevels() {
                            analyser.getByteFrequencyData(dataArray);
                            const avgAmplitude = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
    
                            const event = new CustomEvent('audio-level', { detail: { amplitude: avgAmplitude / 255 } });
                            window.dispatchEvent(event);
                            if (!audio.paused && !audio.ended) {
                                requestAnimationFrame(emitAudioLevels);
                            }
                        }
    
                        audio.onplay = function() {
                            const event2 = new CustomEvent('hablar');
                            window.dispatchEvent(event2);
                            isBotSpeaking = true;
                            emitAudioLevels();
                            if (recognition) recognition.stop(); 
                            mostrarSubtitulosProgresivos(responseText, audio.duration, subtitulosContainer);
                        };
    
                        audio.onended = function() {
                            const event3 = new CustomEvent('parar');
                            window.dispatchEvent(event3);
                            isBotSpeaking = false;
                            if (isListening) recognition.start();
                            const event = new CustomEvent('audio-level', { detail: { amplitude: 0 } });
                            window.dispatchEvent(event);
                            subtitulosContainer.style.display = "none"; 
                        };
    
                        audio.play();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        subtitulosContainer.style.display = "none"; // Ocultar subt√≠tulos en caso de error
                    });
                }
                // Funci√≥n para mostrar subt√≠tulos progresivamente
                function mostrarSubtitulosProgresivos(textoCompleto, duracionAudio, contenedor) {
                    const palabras = textoCompleto.split(" ");
                    const tiempoPorPalabra = duracionAudio / palabras.length;
    
                    contenedor.textContent = ""; // Limpia los subt√≠tulos previos
                    contenedor.style.display = "block";
    
                    let indice = 0;
    
                    const intervalo = setInterval(() => {
                        if (indice < palabras.length) {
                            contenedor.textContent += palabras[indice] + " "; // A√±ade palabra actual
                            indice++;
                        } else {
                            clearInterval(intervalo); // Det√©n el intervalo cuando terminen las palabras
                        }
                    }, tiempoPorPalabra * 50001); // Convierte el tiempo por palabra a milisegundos
                }
                const dots = document.getElementById("dots");
                // Evento al hacer clic en el bot√≥n de enviar texto manualmente
                document.getElementById("send-button").onclick = function() {
        const userInput = document.getElementById("user-input").value.trim(); // Elimina espacios en blanco
        if (userInput) { // Si el input no est√° vac√≠o
            sendMessage(userInput);
            
            // Cambiar la opacidad de los puntos
            const dots = document.getElementById("dots");
            const event3 = new CustomEvent('pensar');
            window.dispatchEvent(event3);
            dots.style.opacity = 1; // Mostrar los puntos
        } else {
            alert("Please enter a message before sending.");
        }
    };
                // Funcionalidad para abrir la c√°mara
                document.getElementById("camera-button").onclick = function() {
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
                            videoPreview.srcObject = stream;
                            videoPreview.style.display = "block";
                            document.getElementById("capture-button").style.display = "block";
                        }).catch(function(error) {
                            console.error("Error al acceder a la c√°mara: ", error);
                        });
                    }
                };
    
                // Funcionalidad para capturar imagen de la c√°mara
                captureButton.onclick = function() {
                    const context = canvas.getContext('2d');
                    canvas.width = videoPreview.videoWidth;
                    canvas.height = videoPreview.videoHeight;
                    context.drawImage(videoPreview, 0, 0);
                    const imageData = canvas.toDataURL('image/png');
                    imagePreview.src = imageData;
                    imagePreview.style.display = "block";
    
                    // Detener el stream de video
                    const stream = videoPreview.srcObject;
                    const tracks = stream.getTracks();
                    tracks.forEach(track => track.stop());
                    videoPreview.srcObject = null;
                    videoPreview.style.display = "none";
                    captureButton.style.display = "none";
    
                    // Enviar la imagen capturada al servidor
                    canvas.toBlob(function(blob) {
                        const formData = new FormData();
                        formData.append('image', blob, 'captured-image.png');
                        formData.append('model', selectedModel);
    
                        fetch('/upload-image', {
                            method: 'POST',
                            body: formData,
                        })
                        .then(response => response.json())
                        .then(data => {
                            // Muestra la alerta SweetAlert2
                            Swal.fire({
                                title: 'Success!',
                                text: 'Image uploaded successfully',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
    
                            document.getElementById("chat-box").innerHTML += `<div>Modelo: ${data.response}</div>`;
                            speakResponse(data.response);
                        })
                        .catch(error => console.error('Error:', error));
                    }, 'image/png');
                };
    
                // Evento al hacer clic en el bot√≥n de cargar imagen
                document.getElementById("upload-button").onclick = function() {
                    const file = imageInput.files[0];
    
                    if (file) {
                        const formData = new FormData();
                        formData.append('image', file);
                        formData.append('model', selectedModel);
                        dots.style.opacity = 1; // Mostrar los puntos
                        const event4 = new CustomEvent('pensar');
                        window.dispatchEvent(event4);
                        fetch('/upload-image', {
                            method: 'POST',
                            body: formData,
                        })
                        .then(response => response.json())
                        .then(data => {
                                // Muestra la alerta SweetAlert2
                                Swal.fire({
                                title: 'Success!',
                                text: 'Image uploaded successfully',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });
    
                            document.getElementById("chat-box").innerHTML += `<div>Modelo: ${data.response}</div>`;
                            speakResponse(data.response);
                        })
                        .catch(error => console.error('Error:', error));
                    }
                };
    
                // Vista previa de la imagen cargada
                imageInput.onchange = function() {
                    const file = imageInput.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = "block";
                    };
                    reader.readAsDataURL(file);
                };
                document.getElementById("download-button").onclick = function() {
        const chatBox = document.getElementById("chat-box");
        const recommendationsList = document.getElementById("recommendations-list");
    
        if (!chatBox || chatBox.children.length === 0) {
            alert("No hay conversaciones disponibles para descargar.");
            return;
        }
    
        // Obtener el texto de la conversaci√≥n
        const conversationText = Array.from(chatBox.children)
            .map(child => child.textContent.trim())
            .join("\n\n");
    
        // Obtener el texto de las recomendaciones
        const recommendationsText = Array.from(recommendationsList.children)
            .map(child => {
                if (child.querySelector('a')) {
                    // Si es un enlace, obtener el texto y la URL
                    const link = child.querySelector('a');
                    return `${link.textContent}: ${link.href}`;
                } else {
                    // Si no es un enlace, obtener el texto normal
                    return child.textContent.trim();
                }
            })
            .join("\n\n");
    
        // Combinar el texto de la conversaci√≥n y las recomendaciones
        const fullText = `Conversaci√≥n:\n${conversationText}\n\nRecomendaciones:\n${recommendationsText}`;
    
        // Verificar si hay texto para generar el PDF
        if (!fullText) {
            alert("No hay contenido para generar el archivo PDF.");
            return;
        }
    
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
    
            const pageWidth = pdf.internal.pageSize.getWidth();
            const margin = 10;
            const maxLineWidth = pageWidth - margin * 2;
    
            pdf.setFont("Helvetica", "normal");
            pdf.setFontSize(12);
    
            const textLines = pdf.splitTextToSize(fullText, maxLineWidth);
            pdf.text(textLines, margin, margin + 10);
    
            // Descargar el archivo
            pdf.save("conversation_and_recommendations.pdf");
        } catch (error) {
            console.error("Error al generar el PDF:", error);
            alert("Ocurri√≥ un error al generar el archivo PDF. Verifica la consola para m√°s detalles.");
        }
    };
    
            });
        </script>    
    <script src="../static/java/avatar.js"></script>
</body>
</html>